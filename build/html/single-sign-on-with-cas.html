<h1>Single sign-on with CAS</h1>
<p>This pages explains how to configure your Bonita BPM Platform system to use CAS to provide single sign-on (SSO). It assumes you already have a working CAS service. All Bonita BPM users must be registered in CAS.</p>
<p>This information applies to a Bonita BPM platform deployed from a bundle, not to the Engine launched from Bonita BPM Studio.</p>
<p>CAS configuration is at tenant level. Each tenant can use a different CAS service.</p>
<p>Note: On a system using CAS to manage logins, if a user who is not already logged in tries to access a page in the Portal by clicking on a URL link, they are re-directed to the login page.
After logging in, the requested page is not displayed automatically. The user must click the link again.</p>
<h2>Configure Bonita BPM Engine and JBoss for CAS</h2>
<p>The deploy bundle contains the files needed to use CAS with Bonita BPM platform and a JBoss 7 application server. They are contained in <code>cas-3.3.1-jbossas7-module</code>.
You can use this folder to configure CAS for a platform deployed from the JBoss bundle or from the deploy bundle. The <code>cas-3.3.1-jbossas7-module</code> folder contains some jar files that are required.
It also contains a configuration file for the module, <code>module.xml</code>, which defines the jar files to be loaded from the module itself and the dependencies of the module. For example:</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;module xmlns=&quot;urn:jboss:module:1.0&quot; name=&quot;org.jasig.cas&quot;&gt;
    &lt;resources&gt;
        &lt;resource-root path=&quot;cas-client-core-3.3.1.jar&quot; /&gt;
        &lt;resource-root path=&quot;slf4j-api-1.7.1.jar&quot; /&gt;
        &lt;resource-root path=&quot;slf4j-log4j12-1.7.1.jar&quot; /&gt;
        &lt;resource-root path=&quot;log4j-1.2.15.jar&quot; /&gt;
    &lt;/resources&gt;
    &lt;dependencies&gt;
        &lt;system&gt;
            &lt;paths&gt;
                &lt;path name=&quot;org/xml/sax&quot;/&gt;
                &lt;path name=&quot;org/xml/sax/helpers&quot;/&gt;
                &lt;path name=&quot;javax/net/ssl&quot;/&gt;
                &lt;path name=&quot;javax/xml/parsers&quot;/&gt;
                &lt;path name=&quot;javax/security/auth/spi&quot;/&gt;
                &lt;path name=&quot;javax/security/auth/login&quot;/&gt;
                &lt;path name=&quot;javax/security/auth/callback&quot;/&gt;
                &lt;path name=&quot;javax/security/auth&quot;/&gt;
            &lt;/paths&gt;
        &lt;/system&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;
</code></pre>
<p>For a standard installation, it is not usually necessary to modify this file.</p>
<p>To configure Bonita BPM Engine for CAS:</p>
<ol>
<li>If you do not already have it, download the Subscription edition deploy zip from the customer portal.</li>
<li>Add the CAS module. To do this, copy cas-3.3.1-jbossas7-module/org to JBOSS_HOME/modules to merge the CAS module with the existing modules.</li>
<li>Make the CAS module global so that it can be used by any application. To do this, edit <code>JBOSS_HOME/standalone/configuration/standalone.xml</code> and change the definition of the <code>ee</code> subsystem to the following:</li>
</ol>
<pre><code class="language-xml"> &lt;subsystem xmlns=&quot;urn:jboss:domain:ee:1.0&quot;&gt;
    &lt;global-modules&gt;
        &lt;module name=&quot;org.jasig.cas&quot; slot=&quot;main&quot;/&gt;
     &lt;/global-modules&gt;
&lt;/subsystem&gt;
</code></pre>
<ol start="4">
<li>Edit <code>JBOSS_HOME/standalone/configuration/standalone.xml</code> and add the BonitaAuthentication module.
before the <code>&lt;security-domains&gt;</code> tag, insert these lines (specifying the relevant IP addresses and port numbers):</li>
</ol>
<pre><code class="language-xml">&lt;security-domain name=&quot;BonitaAuthentication-1&quot;&gt;
    &lt;authentication&gt;
        &lt;login-module code=&quot;org.jasig.cas.client.jaas.CasLoginModule&quot; flag=&quot;required&quot;&gt;
            &lt;module-option name=&quot;ticketValidatorClass&quot; value=&quot;org.jasig.cas.client.validation.Cas20ServiceTicketValidator&quot;/&gt;
            &lt;module-option name=&quot;casServerUrlPrefix&quot; value=&quot;http://cas_ip_address:cas_port/cas&quot;/&gt;
            &lt;module-option name=&quot;tolerance&quot; value=&quot;20000&quot;/&gt;
            &lt;module-option name=&quot;service&quot; value=&quot;http://cas_ip_address:cas_port/bonita/loginservice&quot;/&gt;
            &lt;module-option name=&quot;defaultRoles&quot; value=&quot;admin,operator&quot;/&gt;
            &lt;module-option name=&quot;roleAttributeNames&quot; value=&quot;memberOf,eduPersonAffiliation&quot;/&gt;
            &lt;module-option name=&quot;principalGroupName&quot; value=&quot;CallerPrincipal&quot;/&gt;
            &lt;module-option name=&quot;roleGroupName&quot; value=&quot;Roles&quot;/&gt;
            &lt;module-option name=&quot;cacheAssertions&quot; value=&quot;true&quot;/&gt;
            &lt;module-option name=&quot;cacheTimeout&quot; value=&quot;480&quot;/&gt;
        &lt;/login-module&gt;
    &lt;/authentication&gt;
&lt;/security-domain&gt;
</code></pre>
<p>Note: The security-domain name must be unique, BonitaAuthentication-1 in the above example.</p>
<ol start="5">
<li>In the <code>CasLoginModule</code> configuration, check that the <code>principalGroupName</code> property is set to <code>CallerPrincipal</code>. This is required to retrieve the username from the Bonita application.
Bonita BPM uses the CAS LoginModule in the JASIG implementation, so see the CAS LoginModule section of the <a href="https://wiki.jasig.org/display/CASC/JAAS+Integration">Jasig documentation</a> for more information.</li>
<li>Update <code>bonita-tenant-sp-custom.properties</code>. If you edit this in <code>bonita-home/engine-server/conf/tenants/template/</code>, the settings will apply to all new tenants.
For an existing tenant, edit the properties file in <code>bonita-home/engine-server/conf/tenants/``_&lt;tenant-id&gt;_</code>.
<ol>
<li>Remove the comment flags from these lines:
<code>authentication.service.ref.name=jaasAuthenticationService</code></li>
<li>Specify the relevant IP address and port number.</li>
</ol>
</li>
</ol>
<pre><code>authenticator.delegate=casAuthenticatorDelegate
authentication.delegate.cas.server.url.prefix=http://ip_address:port
authentication.delegate.cas.service.url=http://ip_address:port/bonita/loginservice
</code></pre>
<ol start="3">
<li>Optionally, to enable a Java client application to access the engine using CAS authentication, uncomment this line:</li>
</ol>
<h2>Configure Bonita BPM Engine and Tomcat for CAS</h2>
<ol>
<li>The CAS implementation relies on JAAS, and is defined in the BonitaAuthentication module of the JAAS configuration file. Set the Java system property <code>java.security.auth.login.config</code> in the Tomcat startup script to point to the JAAS configuration file, <code>bonita-home/client/platform/conf/jaas.config</code>. For example, on Linux, edit <code>setenv.sh</code>, uncomment the line that defines <code>SECURITY_OPTS</code>, and insert the variable <code>SECURITY_OPTS</code> in the line <code>CATALINA_OPTS=..</code>.</li>
</ol>
<p>The <code>bonita-home/client/platform/conf/jaas.config</code> file contains the following (replace <code>ip_address:port</code> with the relevant IP addresses and port numbers, in two places):</p>
<pre><code>BonitaAuthentication-1 {
  org.jasig.cas.client.jaas.CasLoginModule required
    ticketValidatorClass=&quot;org.jasig.cas.client.validation.Cas20ServiceTicketValidator&quot;
    casServerUrlPrefix=&quot;http://ip_address:port/cas&quot;
    tolerance=&quot;20000&quot;
    service=&quot;http://ip_address:port/loginservice&quot;
    defaultRoles=&quot;admin,operator&quot;
    roleAttributeNames=&quot;memberOf,eduPersonAffiliation&quot;
    principalGroupName=&quot;CallerPrincipal&quot;
    roleGroupName=&quot;Roles&quot;
    cacheAssertions=&quot;true&quot;
    cacheTimeout=&quot;480&quot;;
};
</code></pre>
<p>The JAAS configuration file, <code>jaas.config</code>, is sorted by sets of authentication modules. For Bonita BPM, each set matches a tenant configuration and the name is prefixed with <em>BonitaAuthentication-<code>&lt;tenant-id&gt;</code></em>. Make sure there is a set of authentication modules for each tenant in your platform. For each tenant, set the CAS service to point to the application login page and set <code>casServerUrlPrefix</code> to point to the CAS server.</p>
<p>Note: The module name must be unique, BonitaAuthentication-1 in the above example.</p>
<ol start="2">
<li>In the <code>CasLoginModule</code> configuration, check that the <code>principalGroupName</code> property is set to <code>CallerPrincipal</code>. This is required to retrieve the username from the Bonita application.Bonita BPM uses the CAS LoginModule in the JASIG implementation, so see the CAS LoginModule section of the <a href="https://wiki.jasig.org/display/CASC/JAAS+Integration">Jasig documentation</a> for more information.</li>
<li>Put the CAS client core jar (currently <code>cas-client-core-3.2.1.jar</code>) in the <code>/lib</code> folder.</li>
<li>Put <code>commons-logging-1.1.jar</code> in the <code>/lib</code> folder.</li>
<li>Update <code>bonita-tenant-sp-custom.properties</code>. If you edit this in <code>bonita-home/engine-server/conf/tenants/template/</code>, the settings will apply to all new tenants.
For an existing tenant, edit the properties file in <code>bonita-home/engine-server/conf/tenants/``_&lt;tenant-id&gt;_</code>.
<ol>
<li>Remove the comment flags from these lines:
<code>authentication.service.ref.name=jaasAuthenticationService</code></li>
<li>Optionally, to enable a Java client application to access the engine using CAS autentication, uncomment this line:</li>
</ol>
</li>
</ol>
<pre><code>authenticator.delegate=casAuthenticatorDelegate
authentication.delegate.cas.server.url.prefix=http://ip_address:port
authentication.delegate.cas.service.url=http://ip_address:port/bonita/loginservice
</code></pre>
<ol start="3">
<li>Specify the relevant IP address and port number.</li>
</ol>
<h3>Cluster considerations</h3>
<p>If you are configuring Bonita BPM and Tomcat in a cluster environment for CAS, there are some extra steps to do:</p>
<ol>
<li>Copy <code>commons-logging-1.1.1.jar</code> from the <code>bonita.war</code> to <code>tomcat/lib</code>.</li>
<li>Remove the <code>WEB-INF/lib/commons-logging-1.1.1.jar</code> file from the <code>bonita.war</code>.</li>
<li>Remove the <code>tomcat/webapps/bonita/WEB-INF/lib/commons-logging-1.1.1.jar</code> file (if it is present).</li>
</ol>
<h2>Configure Bonita client for CAS</h2>
<ol>
<li>For each tenant, edit <code>authenticationManager-config.properties</code> to enable the CASRemoteAuthenticationManager and its properties.
If you edit this in <code>bonita-home/client/platform/tenant-template/conf/</code>, the settings will apply to all new tenants.
For an existing tenant, edit the properties file in <code>bonita-home/client/tenants/``_&lt;tenant-id&gt;_</code>.
The service URL in the properties file must be the same as that in the JAAS file. The <code>authenticationManager-config.properties</code> will have the following content (specify the relevant IP address and ports):</li>
</ol>
<pre><code>#auth.AuthenticationManager = org.bonitasoft.console.common.server.auth.impl.standard.StandardAuthenticationManagerImplExt
#auth.AuthenticationManager = org.bonitasoft.console.common.server.auth.impl.oauth.OAuthAuthenticationManagerImplExt
# OAuth.serviceProvider = LinkedIn
# OAuth.consumerKey = ove2vcdjptar
# OAuth.consumerSecret = vdaBrCmHvkgJoYz1
# OAuth.callbackURL = http://ip_address:port/loginservice
auth.AuthenticationManager = org.bonitasoft.console.common.server.auth.impl.jaas.cas.CASRemoteAuthenticationManagerImpl
Cas.serverUrlPrefix = http://ip_address:port/cas
Cas.bonitaServiceURL = http://ip_address:port/bonita/loginservice
logout.link.hidden=true
</code></pre>
<ol start="2">
<li>Make sure that the default tenant id is the same on both the client side and server side.
To do this, you can set the <code>platform.tenant.default.id</code> property in <code>bonita-home/client/platform/conf/platform-tenant-config.properties</code>.</li>
</ol>
<h2>Configure logout behaviour</h2>
<h3>Bonita BPM Portal</h3>
<p>If you are using CAS, when users log out of Bonita BPM Portal, they log out of CAS. Therefore they are logged out of all applications that are using the CAS service. To avoid this, you can hide the logout option of the portal.
To do this, set the <code>logout.link.hidden=true</code> option in <code>authenticationManager-config.properties</code>.</p>
<p>If this option is set, when users navigate away from the Portal, they are still logged in to CAS.</p>
<h3>Bonita BPM Engine</h3>
<p>By default, logging out from Bonita BPM Engine logs the user out of CAS. You can change this behavior by implementing your own Authentication Service.</p>
<h2>Manage passwords</h2>
<p>When you are using CAS, the password for a user is managed in your CAS system. However, when you create a user in Bonita BPM Portal, specifying a password is mandatory. This password is ignored.</p>
<h2>LDAP synchronizer and CAS</h2>
<p>If you are using an LDAP service and the <a href="ldap-synchronizer.md">LDAP synchronizer</a> to manage your user data, you can continue to do this and use CAS. The LDAP synchronizer user must be registered in CAS.
Alternatively, the LDAP synchronizer could be run with the tenant technical user, because this bypasses the SSO login.</p>
<p>We recommend that you use LDAP as your master source for information, synchronizing the relevant information with your CAS server.</p>
<h2>Single sign-on with CAS using the REST API</h2>
<p>For detailed information about the procedure to install Restful access on your CAS SSO server, see the following links:
<a href="http://apereo.github.io/cas/4.2.x/index.html">CAS SSO RESTful API</a>
<a href="rest-api-overview.md">Bonita BPM REST API</a></p>
<p><strong>Note:</strong> All calls issued to get the TGT or ST are made to the CAS SSO server.</p>
<h3>Getting the Ticket Granting Ticket (TGT)</h3>
<p>The Ticket Granting Ticket is an exposed resource. It has a unique URL.</p>
<h4><strong>Request for a Ticket Granting Ticket Resource</strong></h4>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Request URL</td>
<td style="text-align:left"><code>http://www.your_cas_server_url/cas/v1/tickets</code></td>
</tr>
<tr>
<td style="text-align:left">Request Method</td>
<td style="text-align:left">POST</td>
</tr>
<tr>
<td style="text-align:left">Form Data</td>
<td style="text-align:left">Username: walter.bates  <br/> Password: bpm</td>
</tr>
</tbody>
</table>
<h4><strong>Response for a Ticket Granting Ticket Resource</strong></h4>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Response</td>
<td style="text-align:left">201 created <br/> <br/><code>Location: http://www.your_cas_server_url/cas/v1/tickets/{TGT}</code></td>
</tr>
</tbody>
</table>
<p>Take the TGT response and paste it in the url of the ST request, below</p>
<h3>Getting the Service Ticket (ST)</h3>
<h4><strong>Request for a Service Ticket</strong></h4>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Request URL</td>
<td style="text-align:left"><code>http://www.your_cas_server_url/cas/v1/tickets/{TGT}</code></td>
</tr>
<tr>
<td style="text-align:left">Request Method</td>
<td style="text-align:left">POST</td>
</tr>
<tr>
<td style="text-align:left">Form Data</td>
<td style="text-align:left">service={form encoded parameter for the service url}</td>
</tr>
</tbody>
</table>
<h4><strong>Response for a Service (ST)</strong></h4>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Response</td>
<td style="text-align:left">200 OK <br/> <br/> {ST}</td>
</tr>
</tbody>
</table>
<p>Take the ST response and paste it in the url of the Bonita BPM Engine login request, below</p>
<h3>Logging into Bonita BPM Engine with Rest API using the service ticket</h3>
<p><strong>Authentication to Bonita BPM Engine</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Request URL</td>
<td style="text-align:left"><code>bonita_server_url/loginservice?ticket={ST}</code></td>
</tr>
<tr>
<td style="text-align:left">Request Method</td>
<td style="text-align:left">GET</td>
</tr>
<tr>
<td style="text-align:left">Form Data</td>
<td style="text-align:left">service={form encoded parameter for the service url}</td>
</tr>
</tbody>
</table>
<p>Limitation: The default AuthenticationFilter that manages CAS authentication applies only to the following pages:</p>
<ul>
<li>/portal</li>
<li>/mobile/*</li>
<li>/portal.js/*</li>
<li>/apps/*</li>
<li>/services/*</li>
</ul>
<p>If you require direct calls to the REST API to authenticate the user. you need to provide a custom Filter.</p>
<h4><strong>Response for a Service (ST)</strong></h4>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Response</td>
<td style="text-align:left">200 OK</td>
</tr>
</tbody>
</table>
