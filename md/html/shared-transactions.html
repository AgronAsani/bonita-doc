<style type="text/css">/** https://gist.github.com/andyferra/2554919#file-github-css **/
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url("../../images/modules/styleguide/para.png") no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url("../../images/modules/pulls/dirty-shade.png") repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0; }

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }

ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

ul :last-child, ol :last-child {
  margin-bottom: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      text-align: left;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      text-align: left;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

pre {
  background-color: #073642;
  color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

</style><link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/solarized_dark.min.css">
<h1 id="4-7-4-shared-transactions">4.7.4 Shared transactions</h1>
<p>There are three entry points to transactions in the Bonita BPM Engine:</p>
<ul>
<li>API call: one transaction for each call. The transaction is opened automatically by the Engine if it has not been opened externally.</li>
<li>Work units: one transaction per work unit (that inherits TxBonitaWork). A work unit is asynchronous, and is executed as soon as possible when an Execution thread becomes available.</li>
<li>Jobs: when a Scheduler job triggers, it opens a new transaction if it is not itself contained in an existing open transaction.</li>
</ul>
<p>If you are accessing the Engine in Local mode, you also have the option of using shared transactions, which means you can include Engine API calls in a transaction that is managed explicitly by a calling program. 
For example, in an application for approving and paying expenses, you could have a single transaction that includes the payment instruction sent to the bank and the process step that informs the user that expenses have been paid. If the bank does not complete the payment, the notification is not sent.</p>
<p>A transaction managed by the caller has the following structure:</p>
<p><code>startTransaction();
try {
   myBusinessLogic1();
   callBonitaBPMEngine();
   myBusinessLogic2();
   commitTransaction();
} catch (Exception e) {
   rollbackTransaction();
}</code></p>
<p>The example below shows how to wrap two Engine API calls in the same transaction. Each call updates the value of a variable, and the transaction guarantees that both values are updated or neither value is updated.</p>
<p>`
long procId = processInstance.getId();
try {
   txManager.begin();
   // We want the following 2 calls to be in the same transaction.
   processAPI.updateProcessDataInstance(dataFoo, procId, new Integer(42));
   processAPI.updateProcessDataInstance(dataBar, procId, new Integer(42));
} finally {
   // We explicitly roll back the current transaction
   txManager.rollback();
}</p>
<p>// Start a new transaction to fetch the data values 
//   and ensure their values were not updated.
txManager.begin();
DataInstance processDataInstanceFoo = processAPI.getProcessDataInstance(dataFoo, procId);
DataInstance processDataInstanceBar = processAPI.getProcessDataInstance(dataBar, procId);
if (((Integer) processDataInstanceFoo.getValue()) != 3 &amp;&amp; ((Integer) processDataInstanceBar.getValue()) != 4) {
   System.err.println(&quot;The values for the variables foo and bar should not have been changed.&quot;);
}
txManager.commit();
`</p>
<p>It is also possible to manage your own transactions in the server side of the Engine using Commands. 
The CommandAPI, which executes some custom code on the server side, enables you to execute code in several transactions if necessary.
To do this, it provides access to the UserTransactionService exposing the following methods:</p>
<ul>
<li><code>registerBonitaSynchronization(BonitaTransactionSynchronization txSync)</code></li>
<li><code>executeInTransaction(Callable callable)</code></li>
</ul>
<p>Two implementation of the executeInTransaction method are provided:</p>
<ul>
<li>Community Edition: basic execution</li>
<li>Subscription Edition: retries, only on certain exceptions (IOException, Row locked, ...)</li>
</ul>
<p>Below are examples of code that can be used in a user Command.</p>
<p>Anonymous class:
<code>final long processInstanceId = 1704;
final SProcessInstanceServiceprocessInstanceService = serviceAccessor.getProcessInstanceService();
SProcessInstance pi = userTransactionService.executeInTransaction(new Callable() {
    @Override
    public SProcessInstance call() throws Exception {
        return processInstanceService.getProcessInstance(processInstanceId);
    }
});</code></p>
<p>Custom class:
`
class MyCallable implements Callable {
    private final ProcessInstanceService processInstanceService;
    private long processInstanceId;</p>
<pre><code>MyCallable(ProcessInstanceService processInstanceService) {
    <span class="hljs-keyword">this</span>.processInstanceService = processInstanceService;
}

<span class="hljs-annotation">@Override</span>
<span class="hljs-keyword">public</span> SProcessInstance <span class="hljs-title">call</span>() <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-keyword">return</span> processInstanceService.getProcessInstance(processInstanceId);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setProcessInstanceId</span>(<span class="hljs-keyword">long</span> processInstanceId) {<span class="hljs-keyword">this</span>.processInstanceId = processInstanceId;}
</code></pre><p>}</p>
<p>class MyCommand extends TenantCommand {
    @Override
    public Serializable execute(final Map parameters, final TenantServiceAccessor serviceAccessor) {
        SProcessInstanceService processInstanceService = serviceAccessor.getProcessInstanceService();
        MyCallable callable = new MyCallable(processInstanceService);
        SProcessInstance processInstance;
        // ... custom treatment...
        callable.setProcessInstanceId(1704);
        // First transaction:
        processInstance = userTransactionService.executeInTransaction(callable);
        // ... custom treatment...
        callable.setProcessInstanceId(1209);
        // Second transaction:
        processInstance = userTransactionService.executeInTransaction(callable);
        // Of course, MyCallable implementation is stateless, so it is reusable.
    }
}
`<script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script></p>
