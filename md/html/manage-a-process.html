<h1 id="manage-a-process">4.5.5 Manage a process</h1>
<p>In this page:</p>
<p><strong><a href="#list_deployed">List the deployed processes</a></strong></p>
<p><strong><a href="#enable_start">Enable a process and start an instance</a></strong></p>
<p><strong><a href="#set_variables">Set variables in a process instance</a> </strong> &gt; &gt; <a href="#set_string_start">Set string variables and start a process instance</a></p>
<blockquote>
<p><a href="#set_start">Set variables of any type and start a process instance</a></p>
</blockquote>
<blockquote>
<p><a href="#create_map">Create a map of variables and values and start a process instance</a></p>
</blockquote>
<blockquote>
<p><a href="#set_custom_variable">For a running process instance, set the value of a custom data type variable</a></p>
</blockquote>
<p><strong><a href="#execute_task">Execute a task</a></strong></p>
<p><strong><a href="#list_i_started">List the processes I started</a></strong></p>
<p><strong><a href="#list_open">List the open instances of a process</a></strong></p>
<p><strong><a href="#get_history">Get the history for a case</a></strong></p>
<p><strong><a href="#query_archived">Query archived process instances</a></strong></p>
<p>**</p>
<p><strong><a href="#stop_instance">Stop a process instance</a></strong></p>
<p><strong><a href="#deploy">Deploy a process</a> </strong>** &gt; &gt; <a href="#from_bar">Deploy and enable a process from a bar file</a></p>
<blockquote>
<p><a href="#from_builder">Deploy and enable a process from the processDefinitionBuilder</a></p>
</blockquote>
<p><strong><a href="#get_design">Get the process design definition</a></strong></p>
<p><strong><a href="#undeploy">Undeploy a process</a></strong></p>
<h2 id="list-the-deployed-processes">List the deployed processes</h2>
<p>This example shows you how to get a list of the deployed processes.</p>
<p>The search options specify that the list is sorted by deployment date, the maximum number of results to list is 100, and the list starts with the first results (that is, the processes that were deployed first).</p>
<p><code>final ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(apiSession); final SearchOptions searchOptions = new SearchOptionsBuilder(0, 100).sort(ProcessDeploymentInfoSearchDescriptor.DEPLOYMENT_DATE, Order.DESC).done(); final SearchResult deploymentInfoResults = processAPI.searchProcessDeploymentInfos(searchOptions);</code></p>
<h2 id="enable-a-process-and-start-an-instance">Enable a process and start an instance</h2>
<p>After a process is deployed it must be enabled.</p>
<p>If a process is not enabled, it is not possible to start a process instance.</p>
<p>To <strong>enable a process</strong>, call the method enableProcess specifying the processDefinition id: <code>// enable the process processAPI.enableProcess(processDefinition.getId()); System.out.println(&quot;A new process was enabled: &quot; + processDefinition.getId());</code></p>
<p>The next step is to <strong>start an instance</strong> of the deployed process: <code>// start the process             final ProcessInstance processInstance = processAPI.startProcess(processDefinition.getId()); System.out.println(&quot;A new process instance was started with id: &quot; + processInstance.getId());</code></p>
<h2 id="set-variables-in-a-process-instance">Set variables in a process instance</h2>
<p>This section contains some examples of how to set the values of some variables using a list of operations when starting an instance of a process and in a running process instance.</p>
<h3 id="set-string-variables-and-start-a-process-instance">Set string variables and start a process instance</h3>
<p>In this example, <code>createInstance</code> takes the process definition name, the process version, a map of text variables and their values, and the session identifier. The <code>startProcess</code> method, which creates the process instance, takes a list of operations, not a map of variables, so the map must be converted into a list of operations that will set the values of the variables in the process instance. The example calls <code>buildAssignOperation</code> for each variable in turn, to build an operation that will assign the value to the variable when the process instance is created. Each operation is built as an assignment expression.</p>
<p>` public void createInstance(String processDefinitionName, String processVersion, Map variables, APISession apiSession) { ProcessAPI processAPI; try { processAPI = TenantAPIAccessor.getProcessAPI(apiSession); long processDefinitionId = processAPI.getProcessDefinitionId(processDefinitionName, processVersion);</p>
<pre><code>    List listOperations = new ArrayList();
    for (String variableName : variables.keySet()) {
        if (variables.get(variableName) == null)</code></pre>
<p>continue; Operation operation = buildAssignOperation(variableName, variables.get(variableName).toString(), String.class.getName(), ExpressionType.TYPE_CONSTANT); listOperations.add(operation); } processAPI.startProcess(processDefinitionId, listOperations, null); } catch (Exception e) { e.printStackTrace(); } }</p>
<p>private Operation buildAssignOperation(final String dataInstanceName, final String newConstantValue, final String className, final ExpressionType expressionType) throws InvalidExpressionException { final LeftOperand leftOperand = new LeftOperandBuilder().createNewInstance().setName(dataInstanceName).done(); final Expression expression = new ExpressionBuilder().createNewInstance(dataInstanceName).setContent(newConstantValue).setExpressionType(expressionType.name()).setReturnType(className).done(); final Operation operation; operation = new OperationBuilder().createNewInstance().setOperator(&quot;=&quot;).setLeftOperand(leftOperand).setType(OperatorType.ASSIGNMENT).setRightOperand(expression).done(); return operation;} `</p>
<h3 id="set-variables-of-any-type-and-start-a-process-instance">Set variables of any type and start a process instance</h3>
<p>In this example, <code>createCase</code> takes the process definition name, the process version, a map of variable names and objects, and the session identifier. The <code>startProcess</code> method, which creates the process instance, takes a list of operations, not a map of variables, so the map must be converted into a list of operations that will set the values of the variables in the process instance. For each variable in turn, the example builds an expression that assigns the value to the variable to the object supplied in the map, specifying the data type by identifying the class of the object. These expressions are concatenated into a list of operations, which is used to initialize the variables when the process instance is created.</p>
<p>` public void createCase(String processDefinitionName, String processVersion, Map variables, ProcessAPI processAPI) {</p>
<pre><code>try {

        long processDefinitionId = processAPI.getProcessDefinitionId(processDefinitionName, processVersion);
        // ----- create list of operations -----
        List listOperations = new ArrayList();
        Map listVariablesSerializable = new HashMap();

        for (String variableName : variables.keySet()) {

            if (variables.get(variableName) == null || (!(variables.get(variableName) instanceof Serializable)))
                continue;
        Object value = variables.get(variableName);
        Serializable valueSerializable = (Serializable) value;

        variableName = variableName.toLowerCase();
        Expression expr = new ExpressionBuilder().createExpression(variableName, variableName, value.getClass().getName(), ExpressionType.TYPE_INPUT);
        Operation op = new OperationBuilder().createSetDataOperation(variableName, expr);
        listOperations.add(op);
        listVariablesSerializable.put(variableName, valueSerializable);
        }

        // ----- start process instance -----
        processAPI.startProcess(processDefinitionId, listOperations, listVariablesSerializable);

        // System.out.println(&quot;*** End Create Case ****&quot;);

    } catch (Exception e) {
          e.printStackTrace();
}</code></pre>
<p>} `</p>
<h3 id="create-a-map-of-variables-and-values-and-start-a-process-instance">Create a map of variables and values and start a process instance</h3>
<p>Version 6.1 of Bonita BPM introduces a new method for starting a case of process and setting the variables.</p>
<p>Create a map specifying the values of the variables required to start a case, then pass it to the <code>instantiateProcess</code> method, as shown in the following example:</p>
<p><code>public void instantiateProcess(String processDefinitionName, String processVersion, Map variables, APISession apiSession)  {     try {         ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(apiSession);         long processId = processAPI.getProcessDefinitionId(processDefinitionName, processVersion);         processAPI.startProcess(processId, variables);     } catch (Exception e) {         e.printStackTrace();     } }</code></p>
<h3 id="for-a-running-process-instance-set-the-value-of-a-custom-data-type-variable">For a running process instance, set the value of a custom data type variable</h3>
<p>To update the value of a variable with a custom data type, you need to call a Groovy script expression that returns the new value of the variable., as shown in the example below:</p>
<p>` final ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(session); final String dataInstanceName = &quot;acase&quot;; final long activityInstanceId = 2;</p>
<p>final LeftOperand leftOperand = new LeftOperandBuilder().createNewInstance().setName(dataInstanceName) .setType(LeftOperand.TYPE_DATA).done(); final Expression expression = new ExpressionBuilder().createGroovyScriptExpression(&quot;updateDataCaseTest&quot;, &quot;new com.bonitasoft.support.Case(&quot;title&quot;, &quot;description&quot;)&quot;, Case.class.getName()); final Operation operation = new OperationBuilder().createNewInstance().setOperator(&quot;=&quot;).setLeftOperand(leftOperand).setType(OperatorType.ASSIGNMENT) .setRightOperand(expression).done();</p>
<p>final List operations = new ArrayList(); operations.add(operation); processAPI.updateActivityInstanceVariables(operations, activityInstanceId, null); `</p>
<p>Note: this applies starting from version 6.3.4.</p>
<p>Another method, <code>updateActivityDataInstance</code> also exists. However, this cannot be used with custom data types if you are using a remote connection, because the data type definition is not present in the Engine.</p>
<h2 id="execute-a-task">Execute a task</h2>
<p>This example shows you how to execute a task.</p>
<p>The task is specified by an activityInstanceID.</p>
<p><code>final ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(apiSession); processAPI.executeFlowNode(activityInstanceID);</code></p>
<h2 id="list-the-processes-i-started">List the processes I started</h2>
<p>This example shows you how to list the open process instances started by the current user.</p>
<p>The search options specify that a maximum of 100 items are listed, starting with the first one.</p>
<p><code>final ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(apiSession); final SearchOptionsBuilder builder = new SearchOptionsBuilder(0, 100); builder.filter(ProcessInstanceSearchDescriptor.STARTED_BY, apiSession().getUserId()); final SearchResult processInstanceResults = processAPI.searchOpenProcessInstances(builder.done());</code></p>
<h2 id="list-the-open-instances-of-a-process">List the open instances of a process</h2>
<p>This example shows you how to list the open instances of a specified process.</p>
<p>The process is specified by the processDefinitonID. The search options specify that a maximum of 100 items are listed, starting with the first one.</p>
<p><code>final ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(apiSession); final SearchOptionsBuilder builder = new SearchOptionsBuilder(0, 100); builder.filter(ProcessInstanceSearchDescriptor.PROCESS_DEFINITION_ID, processDefinitionID); final SearchResult processInstanceResults = processAPI.searchOpenProcessInstances(builder.done());</code></p>
<h2 id="get-the-history-for-a-case">Get the history for a case</h2>
<p>This example shows how to get the history for a case.</p>
<p>A case is a process instance. To get the history, you retrieve the archived process instance, which is specified by processInstanceID.</p>
<p><code>final ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(apiSession); final ArchivedProcessInstance archivedProcessInstance = processAPI.getArchivedProcessInstance(processInstanceID);</code></p>
<h2 id="query-archived-process-instances">Query archived process instances</h2>
<p>This example shows how to get a list of archived process instances that meet a specified filter.</p>
<p>Note that this type of query is only possible with archived process instances.</p>
<p><code>final ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(apiSession); final SearchOptionsBuilder builder = new SearchOptionsBuilder(0, 100); builder.filter(ArchivedProcessInstancesSearchDescriptor., ); final SearchResult archivedProcessInstanceResults = processAPI.searchArchivedProcessInstances(builder.done());</code></p>
<h2 id="stop-a-process-instance">Stop a process instance</h2>
<p>This example shows how to stop (or cancel) an active process instance.</p>
<p>No further activities in this process instance are started.</p>
<p><code>final ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(apiSession); processAPI.cancelProcessInstance(processInstanceID);</code></p>
<h2 id="deploy-a-process">Deploy a process</h2>
<p>This example will show you how to use the Bonita BPM Engine API to deploy and enable a process.</p>
<p>The process can be in a business archive (<code>.bar</code>) file or can be built using the <code>processDefinitionBuilder</code>.</p>
<h3 id="deploy-and-enable-a-process-from-a-bar-file">Deploy and enable a process from a bar file</h3>
<p>First create a business archive from the bar file. In this example, the bar file is <code>/deploy/travelRequest</code>. The process is deployed and enabled in a single step.</p>
<p><code>// create a business archive final BusinessArchive businessArchive = BusinessArchiveFactory.readBusinessArchive(new File(&quot;/deploy/travelRequest&quot;));</code></p>
<p>Now <strong>deploy and enable the process</strong>: <code>// deploy and enable the process final ProcessDefinition processDefinition = getProcessAPI().deployAndEnableProcess(businessArchive);</code></p>
<h3 id="deploy-and-enable-a-process-from-the-processdefinitionbuilder">Deploy and enable a process from the processDefinitionBuilder</h3>
<p>In this example, there are three steps: deploy the process, map the actor, and enable the process.</p>
<p>First deploy the process: <code>// deploy the process final ProcessDefinition processDefinition = processAPI.deploy(processDefinitionBuilder.done()); System.out.println(&quot;A new process was deployed with id: &quot; + processDefinition.getId());</code></p>
<p>Once the process is deployed, it's necessary to <strong>map the actors</strong> defined in the process to existing users in the database before enabling the process. In this example, the actor defined in the process will be mapped to the current logged in user, whose id is available in the session (attention, this user cannot be the technical user): <code>// map the actor &quot;delivery&quot; to the current logged in user final List actors = processAPI.getActors(processDefinition.getId(), 0, 1, ActorCriterion.NAME_ASC); processAPI.addUserToActor(actors.get(0).getId(), session.getUserId());</code></p>
<p>At this point, the process is deployed but not enabled. This means that no instances of this process can be started. To <strong>enable the process</strong>, call the method enableProcess: <code>// enable the process processAPI.enableProcess(processDefinition.getId()); System.out.println(&quot;A new process was enabled: &quot; + processDefinition.getId());</code></p>
<h2 id="get-the-process-design-definition">Get the process design definition</h2>
<p>This example shows how to retrieve the definition of a deployed process.</p>
<p>` //Create a process definition final ProcessDefinitionBuilder processBuilder = new ProcessDefinitionBuilder().createNewInstance(&quot;name&quot;, &quot;1.0&quot;); processBuilder.addDescription(&quot;description&quot;); processBuilder.addAutomaticTask(&quot;AutomaticTask&quot;);</p>
<p>//Deploy and enable the process final ProcessDefinition processDefinition = getProcessAPI().deploy( new BusinessArchiveBuilder().createNewBusinessArchive().setProcessDefinition(processBuilder.done()).done()); getProcessAPI().enableProcess(processDefinition.getId());</p>
<p>//Get the design process definition final DesignProcessDefinition resultDesignProcessDefinition = getProcessAPI().getDesignProcessDefinition(processDefinition.getId()); `</p>
<h2 id="undeploy-a-process">Undeploy a process</h2>
<p>This example shows you how to undeploy a process.</p>
<p>A process is undeployed by deleting the processDefinition, specified by a processDefinitionID.</p>
<p>After the process is undeployed, no new instance can be started. Existing instances continue to completion.</p>
<p><code>final ProcessAPI processAPI = TenantAPIAccessor.getProcessAPI(apiSession); processAPI.deleteProcessDefinition(processDefinitionId)</code></p>
